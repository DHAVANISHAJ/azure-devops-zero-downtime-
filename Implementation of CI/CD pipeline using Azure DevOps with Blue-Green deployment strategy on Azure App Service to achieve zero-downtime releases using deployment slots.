trigger:
- main

variables:
  azureSubscription: 'Your-Service-Connection-Name'
  appName: 'your-app-service-name'
  resourceGroupName: 'your-resource-group'
  stagingSlotName: 'staging'

stages:

# =========================
# 1️⃣ Build Stage
# =========================
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: Build
    pool:
      name: Default   # Change if using Microsoft-hosted agent

    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '6.x'
      displayName: "Install .NET SDK"

    - script: |
        dotnet restore
        dotnet build --configuration Release
        dotnet publish -c Release -o $(Build.ArtifactStagingDirectory)
      displayName: "Build & Publish"

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
      displayName: "Publish Artifact"

# =========================
# 2️⃣ Deploy to Staging
# =========================
- stage: Deploy_Staging
  displayName: "Deploy to Staging Slot"
  dependsOn: Build
  jobs:
  - deployment: DeployStaging
    environment: "staging"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Staging Slot"
            inputs:
              azureSubscription: $(azureSubscription)
              appName: $(appName)
              resourceGroupName: $(resourceGroupName)
              package: $(Pipeline.Workspace)/drop/**/*.zip
              deployToSlotOrASE: true
              slotName: $(stagingSlotName)

# =========================
# 3️⃣ Manual Approval
# =========================
- stage: Approval
  displayName: "Manual Approval Before Production"
  dependsOn: Deploy_Staging
  jobs:
  - job: WaitForApproval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Please validate the staging environment before approving production deployment."
        onTimeout: 'reject'
        timeoutInMinutes: 1440

# =========================
# 4️⃣ Slot Swap (Zero Downtime)
# =========================
- stage: Swap_To_Production
  displayName: "Swap Staging to Production"
  dependsOn: Approval
  jobs:
  - job: SwapSlots
    steps:
    - task: AzureAppServiceManage@0
      displayName: "Swap Slots"
      inputs:
        azureSubscription: $(azureSubscription)
        Action: 'Swap Slots'
        WebAppName: $(appName)
        ResourceGroupName: $(resourceGroupName)
        SourceSlot: $(stagingSlotName)
